// ==UserScript==
// @name              ÁΩëÁõòÊô∫ËÉΩËØÜÂà´Âä©Êâã(NEXT)
// @namespace         https://github.com/52fisher/panAI
// @version           3.0.0
// @author            YouXiaoHou,52fisher
// @description       Êô∫ËÉΩËØÜÂà´ÈÄâ‰∏≠ÊñáÂ≠ó‰∏≠ÁöÑüîóÁΩëÁõòÈìæÊé•ÂíåüîëÊèêÂèñÁ†ÅÔºåËØÜÂà´ÊàêÂäüÊâìÂºÄÁΩëÁõòÈìæÊé•Âπ∂Ëá™Âä®Â°´ÂÜôÊèêÂèñÁ†ÅÔºåÁúÅÂéªÊâãÂä®Â§çÂà∂ÊèêÂèñÁ†ÅÂú®ËæìÂÖ•ÁöÑÁÉ¶ÊÅº„ÄÇ
// @license           AGPL-3.0-or-later
// @homepage          https://github.com/52fisher/panAI
// @supportURL        https://github.com/52fisher/panAI
// @updateURL         https://ghproxy.net/https://raw.githubusercontent.com/52fisher/panAI/main/panai_next.user.js
// @downloadURL       https://ghproxy.net/https://raw.githubusercontent.com/52fisher/panAI/main/panai_next.user.js
// @match             *://*/*
// @require           https://unpkg.com/hotkeys-js@3.13.3/dist/hotkeys.min.js
// @run-at            document-idle
// @grant             GM_openInTab
// @grant             GM_setValue
// @grant             GM_getValue
// @grant             GM_registerMenuCommand
// @grant             GM_getResourceText
// @grant             GM_info
// @icon              data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMjggMTI4Ij48cGF0aCBkPSJNMTAzLjYgMTA3LjRjMy41LTIuMiA4LjktNi4xIDEzLjgtMTIuNXM3LjMtMTIuNSA4LjUtMTYuNWMuNS0xLjcgMi4yLTcuNSAyLjItMTQuNyAwLTEwLjEtMy4zLTI1LjEtMTUuNC0zNi44LTE0LjUtMTQtMzIuMS0xNC4zLTM1LjctMTQuMy04IDAtMTUuNyAxLjktMjIuNiA1LjJDNDQgMjMgMzUuNyAzMS40IDMwLjggNDEuN2MtMS4zIDIuOC00IDQuNy03LjEgNS00IC4zLTcuNSA0LjQtOC45IDkuNi0uNSAxLjktMS42IDMuNS0zLjEgNC43QzQuNCA2Ni44IDAgNzUuNyAwIDg1YzAgNi44IDIuMyAxMy4xIDYuMSAxOC4yIDUuNSA3LjQgMTQuMiAxMi4yIDI0IDEyLjJoNDcuMWM0LjQgMCAxMS0uNSAxOC4zLTMuNSAzLjItMS40IDUuOS0zIDguMS00LjV6IiBmaWxsPSIjNDQ0Ii8+PHBhdGggZD0iTTExOS44IDY0LjNjLjEtMTcuMS0xMC40LTI4LTEyLjUtMzAuMUM5NSAyMi4xIDc5LjkgMjEuOCA3Ni45IDIxLjhjLTE3LjYgMC0zMy4zIDEwLjUtMzkuOSAyNi43LS42IDEuMy0xLjggMi4zLTMuNCAyLjNoLS40Yy01LjggMC0xMC42IDQuOC0xMC42IDEwLjd2LjVjMCAxLjQtLjggMi42LTEuOSAzLjNDMTMuNCA2OSA4LjggNzYuOCA4LjggODVjMCAxMi4yIDkuOSAyMi4zIDIyLjIgMjIuM2g0NS4yYzMuNi0uMSAxNy42LS45IDI5LjYtMTIgMi45LTIuOCAxMy45LTEzLjcgMTQtMzF6IiBmaWxsPSIjZGI4NDEyIi8+PHBhdGggZD0iTTExMC44IDU3LjRsLjIgMy4zYzAgMS4zLTEuMSAyLjQtMi4zIDIuNC0xLjMgMC0yLjMtMS4xLTIuMy0yLjRsLS4xLTIuOHYtLjNjMC0xLjIuOS0yLjIgMi4xLTIuM2guM2MuNyAwIDEuMy4zIDEuNy43LS4yLjEuMy41LjQgMS40em0tMy4zLTEwLjNjMCAxLjItMSAyLjMtMi4yIDIuM2gtLjFjLS44IDAtMS42LS41LTItMS4yLTQuNi04LjMtMTMuMy0xMy41LTIyLjgtMTMuNS0xLjIgMC0yLjMtMS0yLjMtMi4ydi0uMWMwLTEuMiAxLTIuMyAyLjItMi4zaC4xYTMwLjM3IDMwLjM3IDAgMCAxIDE1LjggNC40YzQuNiAyLjggOC40IDYuOCAxMS4xIDExLjUuMS4zLjIuNy4yIDEuMXpNNjkuMiA0OWwxOS40IDE0LjhjMS45IDEuNSAzLjEgMy41IDMuNSA1Ljd2LjJjLjEuNC4xLjguMSAxLjIgMCAuNi0uMSAxLjEtLjIgMS42LS40IDIuMi0xLjcgNC4yLTMuNSA1LjZMNjkuMyA5M2MtMi42IDItNS40IDIuNS03LjcgMS40LS4xLS4xLS4yLS4xLS4yLS4yLTItMS4yLTMuMi0zLjUtMy4yLTYuNHYtNi42aC01LjdjLTYuOCAwLTEyLTQuNy0xMi0xMC45IDAtNC44IDIuNi04LjUgNy4yLTEwLjMgMS4zLS41IDIuNy4yIDMuMiAxLjVzLS4xIDIuOC0xLjQgMy4zYy0yLjcgMS4xLTQgMi45LTQgNS41IDAgMy41IDMgNiA3IDZoOC4xYy41IDAgMSAuMiAxLjQuNi43LjYgMS4xIDEuNyAxLjEgMi42djguNGMwIDEuMy40IDIgLjcgMi4xLjQuMiAxLjMgMCAyLjQtLjlsMTkuMi0xNC45YzEuMi0uOSAxLjgtMi4xIDEuOC0zLjNzLS42LTIuMy0xLjctMy4xTDY2LjIgNTNjLTEuMS0uOS0yLTEuMS0yLjQtLjktLjMuMi0uNy45LS43IDIuMXY3LjZjMCAuOS0uNSAxLjctMS4yIDIuMS0uNC4zLS44LjQtMS4zLjQtMS40IDAtMi41LTEuMS0yLjUtMi41di03LjZjMC0zLjEgMS4zLTUuNSAzLjUtNi42bC43LS4zYzIuMS0uNyA0LjYtLjEgNi45IDEuN3oiIGZpbGw9IiM0NDQiLz48L3N2Zz4=
// ==/UserScript==

(function () {

    // Â∏∏ÈáèÂÆö‰πâ
    const CONSTANTS = {
        DEFAULT_SETTINGS: [
            { name: 'setting_success_times', value: 0 },
            { name: 'setting_auto_click_btn', value: true },
            { name: 'setting_active_in_front', value: true },
            { name: 'setting_timer_open', value: false },
            { name: 'setting_auto_complete', value: false },
            { name: 'setting_text_as_password', value: false },
            { name: 'setting_timer', value: 5000 },
            { name: 'setting_hotkeys', value: 'F1' }
        ],
        CUSTOM_CLASSES: {
            dialog: 'panai-dialog',
            dialogOverlay: 'panai-dialog-overlay',
            dialogContent: 'panai-dialog-content',
            dialogHeader: 'panai-dialog-header',
            dialogTitle: 'panai-dialog-title',
            dialogBody: 'panai-dialog-body',
            dialogFooter: 'panai-dialog-footer',
            confirmButton: 'panai-confirm-btn',
            cancelButton: 'panai-cancel-btn',
            denyButton: 'panai-deny-btn',
            timerBar: 'panai-timer-bar'
        },
        PASSWORD_REGEX: /wss:[a-zA-Z0-9]+|(?<=\s*(?:ÂØÜ|ÊèêÂèñ|ËÆøÈóÆ|Ë®™Âïè|key|password|pwd|#|\?p=|\?code=)\s*[Á†ÅÁ¢º]?\s*[Ôºö:=]?\s*)[a-zA-Z0-9]{3,8}/i,
        PLUGIN_STYLES: `
        .panai-setting-label { display: flex;align-items: center;justify-content: space-between;padding-top: 20px; }
        .panai-setting-checkbox { width: 16px;height: 16px; }
        .panai-dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100000;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        .panai-dialog-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        .panai-dialog-content {
            background: white;
            border-radius: 8px;
            width: fit-content;
            max-width: 500px;
            box-shadow: 10px 10px 24px 6px rgba(0,0,0,0.1);
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        .panai-dialog-overlay.active .panai-dialog-content {
            transform: translateY(0);
        }
        .panai-dialog-header {
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .panai-dialog-title {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        .panai-dialog-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #999;
            padding: 0 5px;
        }
        .panai-dialog-close:hover {
            color: #333;
        }
        .panai-dialog-body {
            padding: 0 20px;
            max-height: 70vh;
            overflow-y: auto;
        }
        .panai-dialog-footer {
            padding: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .panai-dialog-footer button {
            padding: 6px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        .panai-cancel-btn {
            background: #f5f5f5;
            border: 1px solid #ddd;
            color: #666;
        }
        .panai-cancel-btn:hover {
            background: #eee;
        }
        .panai-confirm-btn {
            background: #2778c4;
            border: 1px solid #2778c4;
            color: white;
        }
        .panai-confirm-btn:hover {
            background: #1e64b2;
        }
        .panai-deny-btn {
            background: #f59e0b;
            border: 1px solid #f59e0b;
            color: white;
        }
        .panai-deny-btn:hover {
            background: #d97706;
        }
        .panai-toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            z-index: 100001;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            max-width: 80%;
            text-align: center;
        }
        .panai-toast.active {
            opacity: 1;
        }
        .panai-toast.success {
            background: #F0F9EB;
            color:#67C23A;
        }
        .panai-toast.error {
            background: #FEF0F0;
            color:#F56C6C;
        }
        .panai-toast.info {
            background: #FDF6EC;
            color:#E6A23C;
        }
        .panai-timer-bar {
            height: 3px;
            background: #2778c4;
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            transition: width linear;
        }
        .panai-dialog-body textarea,.panai-dialog-body input[type="text"], .panai-dialog-body input[type="range"] {
            width: 100%;
            padding: 8px 12px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
       .panai-dialog-body textarea {
            min-height: 100px;
            resize: vertical;
        }
    `
    };

    // Ëá™ÂÆö‰πâDialogÁªÑ‰ª∂
    class Dialog {
        constructor() {
            // ÁªëÂÆötoastÊñπÊ≥ïÁöÑ‰∏ä‰∏ãÊñáÔºåÁ°Æ‰øùthisÊåáÂêëÊ≠£Á°Æ
            this.toast = this.toast.bind(this);
            this.createElements();
            this.bindEvents();
        }

        // ÂàõÂª∫Âü∫Á°ÄDOMÂÖÉÁ¥†
        createElements() {
            // ÂàõÂª∫ÈÅÆÁΩ©Â±ÇÂíåÂØπËØùÊ°ÜÂÆπÂô®
            this.overlay = document.createElement('div');
            this.overlay.className = `${CONSTANTS.CUSTOM_CLASSES.dialogOverlay}`;

            this.content = document.createElement('div');
            this.content.className = `${CONSTANTS.CUSTOM_CLASSES.dialogContent}`;

            // ÂàõÂª∫ÂØπËØùÊ°ÜÁªìÊûÑ
            this.header = document.createElement('div');
            this.header.className = `${CONSTANTS.CUSTOM_CLASSES.dialogHeader}`;

            this.title = document.createElement('h3');
            this.title.className = `${CONSTANTS.CUSTOM_CLASSES.dialogTitle}`;

            this.closeBtn = document.createElement('button');
            this.closeBtn.className = 'panai-dialog-close';
            this.closeBtn.innerHTML = '&times;';

            this.body = document.createElement('div');
            this.body.className = `${CONSTANTS.CUSTOM_CLASSES.dialogBody}`;

            this.footer = document.createElement('div');
            this.footer.className = `${CONSTANTS.CUSTOM_CLASSES.dialogFooter}`;

            // ÂàõÂª∫toastÂÖÉÁ¥†
            this.toastElement = document.createElement('div');
            this.toastElement.className = 'panai-toast';

            // ÁªÑË£ÖÂØπËØùÊ°Ü
            this.header.appendChild(this.title);
            //this.header.appendChild(this.closeBtn);
            this.content.appendChild(this.header);
            this.content.appendChild(this.body);
            this.content.appendChild(this.footer);
            this.overlay.appendChild(this.content);

            // Ê∑ªÂä†Âà∞È°µÈù¢
            document.body.appendChild(this.overlay);
            document.body.appendChild(this.toastElement);

            // ËÆ°Êó∂Âô®Áõ∏ÂÖ≥
            this.timer = null;
            this.timerBar = null;
            this.resolve = null;
        }

        // ÁªëÂÆö‰∫ã‰ª∂
        bindEvents() {
            // ÂÖ≥Èó≠ÊåâÈíÆ‰∫ã‰ª∂
            this.closeBtn.addEventListener('click', () => {
                this.hide();
                if (this.resolve) {
                    this.resolve({ isConfirmed: false, dismiss: 'close' });
                    this.resolve = null;
                }
            });

            // ÁÇπÂáªÈÅÆÁΩ©Â±ÇÂÖ≥Èó≠
            this.overlay.addEventListener('click', (e) => {
                if (e.target === this.overlay) {
                    this.closeBtn.click();
                }
            });

            // ESCÈîÆÂÖ≥Èó≠
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && this.overlay.classList.contains('active')) {
                    this.closeBtn.click();
                }
            });
        }

        // ÊòæÁ§∫ÂØπËØùÊ°Ü
        show() {
            this.overlay.classList.add('active');
        }

        // ÈöêËóèÂØπËØùÊ°Ü
        hide() {
            this.overlay.classList.remove('active');
            this.clearButtons();
            this.clearTimer();

            // Ê∏ÖÁ©∫ÂÜÖÂÆπ
            this.body.innerHTML = '';
            this.title.innerHTML = '';
        }

        // Ê∏ÖÈô§ÊåâÈíÆ
        clearButtons() {
            while (this.footer.firstChild) {
                this.footer.removeChild(this.footer.firstChild);
            }
        }

        // Ê∏ÖÈô§ËÆ°Êó∂Âô®
        clearTimer() {
            if (this.timer) {
                clearInterval(this.timer);
                this.timer = null;
            }
            if (this.timerBar) {
                this.content.removeChild(this.timerBar);
                this.timerBar = null;
            }
        }

        // ÂàõÂª∫ÊåâÈíÆ
        createButton(text, className, callback) {
            const button = document.createElement('button');
            button.textContent = text;
            button.className = className;
            button.type = 'button';
            button.addEventListener('click', callback);
            this.footer.appendChild(button);
            return button;
        }

        // ÊôÆÈÄöÊèêÁ§∫Ê°Ü
        alert(options) {
            return new Promise((resolve) => {
                this.title.innerHTML = options.title || '';
                this.body.innerHTML = options.html || options.text || '';

                // Ê∏ÖÈô§Áé∞ÊúâÊåâÈíÆÂπ∂ÂàõÂª∫Á°ÆËÆ§ÊåâÈíÆ
                this.clearButtons();
                this.createButton(options.confirmButtonText || 'Á°ÆÂÆö',
                    `${CONSTANTS.CUSTOM_CLASSES.confirmButton}`, () => {
                        this.hide();
                        resolve({ isConfirmed: true });
                    });

                this.show();
            });
        }

        // Á°ÆËÆ§ÂØπËØùÊ°Ü
        confirm(options) {
            return new Promise((resolve) => {
                this.resolve = resolve;
                this.title.innerHTML = options.title || '';
                this.body.innerHTML = options.html || options.text || '';

                // Ê∏ÖÈô§Áé∞ÊúâÊåâÈíÆ
                this.clearButtons();

                // ÂàõÂª∫ÂèñÊ∂àÊåâÈíÆ
                this.createButton(options.cancelButtonText || 'ÂèñÊ∂à',
                    `${CONSTANTS.CUSTOM_CLASSES.cancelButton}`, () => {
                        this.hide();
                        resolve({ isConfirmed: false });
                        this.resolve = null;
                    });

                // ÂàõÂª∫Á°ÆËÆ§ÊåâÈíÆ
                this.createButton(options.confirmButtonText || 'Á°ÆÂÆö',
                    `${CONSTANTS.CUSTOM_CLASSES.confirmButton}`, () => {
                        const inputs = this.body.querySelectorAll('input, textarea');
                        const inputValues = {};
                        inputs.forEach(input => {
                            inputValues[input.id] = input.value;
                        });

                        this.hide();
                        // Âú®ËøîÂõûÁªìÊûú‰∏≠ÂåÖÂê´ inputValues
                        resolve({ isConfirmed: true, inputValues });
                        this.resolve = null;
                    });

                // Ê∑ªÂä†ËÆ°Êó∂Âô®
                if (options.timer) {
                    this.timerBar = document.createElement('div');
                    this.timerBar.className = CONSTANTS.CUSTOM_CLASSES.timerBar;
                    this.content.appendChild(this.timerBar);

                    let timeLeft = options.timer;
                    const totalTime = options.timer;

                    this.timer = setInterval(() => {
                        timeLeft -= 100;
                        const percentage = (timeLeft / totalTime) * 100;
                        this.timerBar.style.width = `${percentage}%`;

                        if (timeLeft <= 0) {
                            clearInterval(this.timer);
                            this.hide();
                            resolve({ isConfirmed: true, dismiss: 'timer' });
                            this.resolve = null;
                        }
                    }, 100);
                }

                this.show();
            });
        }

        // Â∏¶Âê¶ËÆ§ÊåâÈíÆÁöÑÂØπËØùÊ°Ü
        confirmWithDeny(options) {
            return new Promise((resolve) => {
                this.resolve = resolve;
                this.title.innerHTML = options.title || '';
                this.body.innerHTML = options.html || options.text || '';

                // Ê∏ÖÈô§Áé∞ÊúâÊåâÈíÆ
                this.clearButtons();

                // ÂàõÂª∫ÂèñÊ∂àÊåâÈíÆ
                this.createButton(options.cancelButtonText || 'ÂèñÊ∂à',
                    `${CONSTANTS.CUSTOM_CLASSES.cancelButton}`, () => {
                        this.hide();
                        resolve({ isConfirmed: false });
                        this.resolve = null;
                    });

                // ÂàõÂª∫Âê¶ËÆ§ÊåâÈíÆ
                this.createButton(options.denyButtonText || 'Âê¶',
                    `${CONSTANTS.CUSTOM_CLASSES.denyButton}`, () => {
                        this.hide();
                        resolve({ isDenied: true });
                        this.resolve = null;
                    });

                // ÂàõÂª∫Á°ÆËÆ§ÊåâÈíÆ
                this.createButton(options.confirmButtonText || 'ÊòØ',
                    `${CONSTANTS.CUSTOM_CLASSES.confirmButton}`, () => {
                        const inputs = this.body.querySelectorAll('input, textarea');
                        const inputValues = {};
                        inputs.forEach(input => {
                            inputValues[input.id] = input.value;
                        });

                        this.hide();
                        // Âú®ËøîÂõûÁªìÊûú‰∏≠ÂåÖÂê´ inputValues
                        resolve({ isConfirmed: true, inputValues });
                        this.resolve = null;
                    });

                this.show();
            });
        }

        // ÊòæÁ§∫ÊèêÁ§∫Ê∂àÊÅØ - ‰øÆÂ§çÂêéÁöÑtoastÊñπÊ≥ï
        toast(options) {
            if (!this.toastElement) {
                // Á°Æ‰øùtoastÂÖÉÁ¥†Â≠òÂú®
                this.toastElement = document.createElement('div');
                this.toastElement.className = 'panai-toast';
                document.body.appendChild(this.toastElement);
            }

            this.toastElement.innerHTML = options.title || '';
            this.toastElement.className = 'panai-toast'; // ÈáçÁΩÆÁ±ªÂêç

            if (options.icon) {
                this.toastElement.classList.add(options.icon);
            }

            this.toastElement.classList.add('active');

            // Ê∏ÖÈô§ÂèØËÉΩÂ≠òÂú®ÁöÑÊóßËÆ°Êó∂Âô®
            if (this.toastTimer) {
                clearTimeout(this.toastTimer);
            }

            // ËÆæÁΩÆËá™Âä®ÈöêËóèËÆ°Êó∂Âô®
            this.toastTimer = setTimeout(() => {
                this.toastElement.classList.remove('active');
            }, options.timer || 3000);
        }
    }

    // Áä∂ÊÄÅÂèòÈáè
    let lastText = "lorem&";
    let dialog; // Ëá™ÂÆö‰πâÂØπËØùÊ°ÜÂÆû‰æã
    let util;
    let PAN_CONFIGS; // ÂÖàÂ£∞ÊòéÔºåÂêéÂàùÂßãÂåñ

    // Â∑•ÂÖ∑ÂáΩÊï∞ÈõÜÂêà
    function createUtil() {
        return {
            /**
             * Â∏¶ÂâçÁºÄÁöÑÊéßÂà∂Âè∞Êó•Âøó
             * @param {any} content - Êó•ÂøóÂÜÖÂÆπ
             */
            clog: (content) => {
                console.group("%c %c [ÁΩëÁõòÊô∫ËÉΩËØÜÂà´Âä©Êâã]",
                    `background:url(${GM_info.script.icon}) center center no-repeat;background-size:12px;padding:3px`, "");
                console.log(content);
                console.groupEnd();
            },

            /**
             * Ëß£ÊûêURLÊü•ËØ¢ÂèÇÊï∞
             * @param {string} name - ÂèÇÊï∞Âêç
             * @returns {string|null} ÂèÇÊï∞ÂÄº
             */
            parseQuery: (name) => {
                const reg = new RegExp(`(?<=(?:${name})\\=)(?:wss:[a-zA-Z0-9]+|[\\w-]+)`, "i");
                const pd = location.href.replace(/%3A/g, ":").match(reg);
                return pd ? pd[0] : null;
            },

            /**
             * Ëé∑ÂèñÂ≠òÂÇ®ÁöÑÂÄº
             * @param {string} name - ÈîÆÂêç
             * @returns {any} ÂÄº
             */
            getValue: (name) => GM_getValue(name),

            /**
             * ËÆæÁΩÆÂ≠òÂÇ®ÁöÑÂÄº
             * @param {string} name - ÈîÆÂêç
             * @param {any} value - ÂÄº
             */
            setValue: (name, value) => GM_setValue(name, value),

            /**
             * Âª∂ËøüÂáΩÊï∞
             * @param {number} time - Âª∂ËøüÊó∂Èó¥(ÊØ´Áßí)
             * @returns {Promise}
             */
            sleep: (time) => new Promise(resolve => setTimeout(resolve, time)),

            /**
             * Ê∑ªÂä†Ê†∑ÂºèÂà∞È°µÈù¢
             * @param {string} id - Ê†∑ÂºèID
             * @param {string} tag - Ê†áÁ≠æÂêç
             * @param {string} css - Ê†∑ÂºèÂÜÖÂÆπ
             */
            addStyle: (id, tag = 'style', css) => {
                const doc = document;
                let styleDom = doc.getElementById(id);
                if (styleDom) return;

                const style = doc.createElement(tag);
                style.rel = 'stylesheet';
                style.id = id;
                tag === 'style' ? style.innerHTML = css : style.href = css;
                document.head.appendChild(style);
            },

            /**
             * Ê£ÄÊü•ÂÖÉÁ¥†ÊòØÂê¶ÈöêËóè
             * @param {HTMLElement} el - ÂÖÉÁ¥†
             * @returns {boolean} ÊòØÂê¶ÈöêËóè
             */
            isHidden: (el) => {
                try {
                    return el.offsetParent === null;
                } catch (e) {
                    return false;
                }
            },

            /**
             * Âà§Êñ≠ÊòØÂê¶‰∏∫ÁßªÂä®ËÆæÂ§á
             */
            isMobile: !!navigator.userAgent.match(
                /(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone|HarmonyOS|MicroMessenger)/i
            ),

            /**
             * Êü•ËØ¢ÂÖÉÁ¥†
             * @param {string|string[]} selector - ÈÄâÊã©Âô®ÊàñÈÄâÊã©Âô®Êï∞ÁªÑ
             * @returns {HTMLElement|null} ÊâæÂà∞ÁöÑÂÖÉÁ¥†
             */
            query: (selector) => {
                if (Array.isArray(selector)) {
                    for (let i = 0; i < selector.length; i++) {
                        const element = document.querySelector(selector[i]);
                        if (element) return element;
                    }
                    return null;
                }
                return document.querySelector(selector);
            }
        };
    }

    /**
     * ÂàùÂßãÂåñÁΩëÁõòÈÖçÁΩÆÔºàÂú®utilÂàùÂßãÂåñ‰πãÂêéË∞ÉÁî®Ôºâ
     */
    function initPanConfigs() {
        PAN_CONFIGS = {
            'baidu': {
                reg: /((?:https?:\/\/)?(?:e?yun|pan)\.baidu\.com\/(doc\/|enterprise\/)?(?:s\/[\w~]*(((-)?\w*)*)?|share\/\S{4,}))/,
                host: /(pan|e?yun)\.baidu\.com/,
                input: ['#accessCode', '.share-access-code', '#wpdoc-share-page > .u-dialog__wrapper .u-input__inner'],
                button: ['#submitBtn', '.share-access .g-button', '#wpdoc-share-page > .u-dialog__wrapper .u-btn--primary'],
                name: 'ÁôæÂ∫¶ÁΩëÁõò',
                storage: 'hash',
                autoCompleteReg: /(?=.*[A-Z])(?=.*[a-z])(?=.*[0-9])\b[\w-]{23}\b/,
                autoCompleteUrlPrefix: 'https://pan.baidu.com/s/'
            },
            'aliyun': {
                reg: /((?:https?:\/\/)?(?:(?:www\.)?(?:aliyundrive|alipan)\.com\/s|alywp\.net)\/[a-zA-Z\d]+)/,
                host: /www\.(aliyundrive|alipan)\.com|alywp\.net/,
                input: ['form .ant-input', 'form input[type="text"]', 'input[name="pwd"]'],
                button: ['form .button--fep7l', 'form button[type="submit"]'],
                name: 'ÈòøÈáå‰∫ëÁõò',
                storage: 'hash'
            },
            'weiyun': {
                reg: /((?:https?:\/\/)?share\.weiyun\.com\/[a-zA-Z\d]+)/,
                host: /share\.weiyun\.com/,
                input: ['.mod-card-s input[type=password]', 'input.pw-input'],
                button: ['.mod-card-s .btn-main', ".pw-btn-wrap button.btn"],
                name: 'ÂæÆ‰∫ë',
                storage: 'hash'
            },
            'lanzou': {
                reg: /((?:https?:\/\/)?(?:[a-zA-Z0-9\-.]+)?(?:lanzou[a-z]|lanzn|lanpv)\.com\/[a-zA-Z\d_\-]+(?:\/[\w-]+)?)/,
                host: /(?:[a-zA-Z\d-.]+)?(?:lanzou[a-z]|lanzn|lanpv)\.com/,
                input: ['#pwd'],
                button: ['.passwddiv-btn', '#sub'],
                name: 'ËìùÂ•è‰∫ë',
                storage: 'hash',
            },
            'ilanzou': {
                reg: /(?:https?:\/\/)?(?:[a-zA-Z0-9\-.]+)?ilanzou\.com\/s\/[?=\w-]+/,
                host: /www\.ilanzou\.com/,
                input: ['.code-input'],
                button: ['.code-checkbefore'],
                name: 'ËìùÂ•è‰∫ë‰ºò‰∫´Áâà',
                storage: 'hash'
            },
            'tianyi': {
                reg: /((?:https?:\/\/)?cloud\.189\.cn\/(?:t\/|web\/share\?code=)?[a-zA-Z\d]+)/,
                host: /cloud\.189\.cn/,
                input: ['.access-code-item #code_txt', "input.access-code-input"],
                button: ['.access-code-item .visit', ".button"],
                name: 'Â§©Áøº‰∫ëÁõò',
                storage: () => util.isMobile === true ? 'local' : 'hash',
                storagePwdName: 'tmp_tianyi_pwd'
            },
            'caiyun': {
                reg: /((?:https?:\/\/)?caiyun\.139\.com\/(?:m\/i|w\/i\/|web\/|front\/#\/detail)\??(?:linkID=)?[a-zA-Z\d]+)/,
                host: /(?:cai)?yun\.139\.com/,
                input: ['.token-form input[type=text]'],
                button: ['.token-form .btn-token'],
                name: 'ÁßªÂä®‰∫ëÁõò',
                storage: 'local',
                storagePwdName: 'tmp_caiyun_pwd'
            },
            'xunlei': {
                reg: /((?:https?:\/\/)?pan\.xunlei\.com\/s\/[\w-]{10,})/,
                host: /pan\.xunlei\.com/,
                input: ['.pass-input-wrap .td-input__inner'],
                button: ['.pass-input-wrap .td-button'],
                name: 'ËøÖÈõ∑‰∫ëÁõò',
                storage: 'hash',
                autoCompleteReg: /(?=.*[A-Z])(?=.*[a-z])(?=.*[0-9])\b[\w-]{26}\b/,
                autoCompleteUrlPrefix: 'https://pan.xunlei.com/s/'
            },
            '123pan': {
                reg: /((?:https?:\/\/)?www\.(?:123pan|123865|123684|123652|123912)\.com\/s\/[\w-]{6,})/,
                host: /www\.(?:123pan|123865|123684|123652|123912)\.com/,
                input: ['.ca-fot input', ".appinput .appinput"],
                button: ['.ca-fot button', ".appinput button"],
                name: '123‰∫ëÁõò',
                storage: 'hash'
            },
            '360': {
                reg: /((?:https?:\/\/)?(?:[a-zA-Z\d\-.]+)?(?:yunpan\.360\.cn|yunpan\.com)(\/lk)?\/surl_\w{6,})/,
                host: /[\w.]+?yunpan\.com/,
                input: ['.pwd-input'],
                button: ['.submit-btn'],
                name: '360‰∫ëÁõò',
                storage: 'local',
                storagePwdName: 'tmp_360_pwd'
            },
            '115': {
                reg: /((?:https?:\/\/)?115\.com\/s\/[a-zA-Z\d]+)/,
                host: /115\.com/,
                input: ['.form-decode input'],
                button: ['.form-decode .submit a'],
                name: '115ÁΩëÁõò',
                storage: 'hash'
            },
            'cowtransfer': {
                reg: /((?:https?:\/\/)?(?:[a-zA-Z\d-.]+)?cowtransfer\.com\/s\/[a-zA-Z\d]+)/,
                host: /(?:[a-zA-Z\d-.]+)?cowtransfer\.com/,
                input: ['.receive-code-input input'],
                button: ['.open-button'],
                name: 'Â•∂ÁâõÂø´‰º†',
                storage: 'hash'
            },
            'ctfile': {
                reg: /((?:https?:\/\/)?(?:[a-zA-Z\d-.]+)?(?:ctfile|545c|u062|ghpym)\.com\/\w+\/[a-zA-Z\d-]+)/,
                host: /(?:[a-zA-Z\d-.]+)?(?:ctfile|545c|u062)\.com/,
                input: ['#passcode'],
                button: ['.card-body button'],
                name: 'ÂüéÈÄöÁΩëÁõò',
                storage: 'hash'
            },
            'quark': {
                reg: /((?:https?:\/\/)?pan\.quark\.cn\/s\/[a-zA-Z\d-]+)/,
                host: /pan\.quark\.cn/,
                input: ['input[class*=ShareReceive]'],
                button: ['.ant-btn-primary'],
                name: 'Â§∏ÂÖãÁΩëÁõò',
                storage: 'local',
                storagePwdName: 'tmp_quark_pwd',
                autoCompleteReg: /(?=.*[a-z])(?=.*[0-9])\b[a-z0-9]{12}\b/,
                autoCompleteUrlPrefix: 'https://pan.quark.cn/s/'
            },
            'pikpak': {
                reg: /((?:https?:\/\/)?mypikpak\.com\/s\/[\w-]+)/,
                host: /(?:[a-zA-Z\d-.]+)?mypikpak\.com/,
                input: ['.el-input__wrapper input'],
                button: ['.passcode-input+button'],
                name: 'PikPak',
                storage: 'hash',
            },
            'feijipan': {
                reg: /((?:https?:\/\/)?share\.feijipan\.com\/s\/[a-zA-Z\d-]+)/,
                host: /share\.feijipan\.com/,
                name: 'È£ûÊú∫Áõò',
                storage: 'hash'
            },
            'vdisk': {
                reg: /(?:https?:\/\/)?vdisk.weibo.com\/lc\/\w+/,
                host: /vdisk\.weibo\.com/,
                input: ['#keypass', "#access_code"],
                button: ['.search_btn_wrap a', "#linkcommon_btn"],
                name: 'ÂæÆÁõò',
                storage: 'hash',
            },
            'wenshushu': {
                reg: /((?:https?:\/\/)?(?:www\.wenshushu|ws28)\.cn\/(?:k|box|f)\/\w+)/,
                host: /www\.wenshushu\.cn/,
                input: ['.pwd-inp .ivu-input'],
                button: ['.pwd-inp .ivu-btn'],
                name: 'ÊñáÂèîÂèîÁΩëÁõò',
                storage: 'hash'
            },
            'uc': {
                reg: /(?:https?:\/\/)?drive\.uc\.cn\/s\/[a-zA-Z\d]+/,
                host: /drive\.uc\.cn/,
                input: ["input[class*='ShareReceivePC--input']", '.input-wrap input'],
                button: ["button[class*='ShareReceivePC--submit-btn'", '.input-wrap button'],
                name: 'UC‰∫ëÁõò',
                storage: 'hash'
            },
            'jianguoyun': {
                reg: /((?:https?:\/\/)?www\.jianguoyun\.com\/p\/[\w-]+)/,
                host: /www\.jianguoyun\.com/,
                input: ['input[type=password]'],
                button: ['.ok-button', '.confirm-button'],
                name: 'ÂùöÊûú‰∫ë',
                storage: 'hash'
            },
            'wo': {
                reg: /(?:https?:\/\/)?pan\.wo\.cn\/s\/[\w_]+/,
                host: /(pan\.wo\.cn|panservice\.mail\.wo\.cn)/,
                input: ['input.el-input__inner', ".van-field__control"],
                button: ['.s-button', ".share-code button"],
                name: 'ËÅîÈÄö‰∫ëÁõò',
                storage: () => util.isMobile === true ? 'local' : 'hash',
                storagePwdName: 'tmp_wo_pwd'
            },
            'mega': {
                reg: /((?:https?:\/\/)?(?:mega\.nz|mega\.co\.nz)\/#F?![\w!-]+)/,
                host: /(?:mega\.nz|mega\.co\.nz)/,
                input: ['.dlkey-dialog input'],
                button: ['.dlkey-dialog .fm-dialog-new-folder-button'],
                name: 'Mega',
                storage: 'local'
            },
            'flowus': {
                reg: /((?:https?:\/\/)?flowus\.cn\/[\S ^\/]*\/?share\/[a-z\d]{8}-[a-z\d]{4}-[a-z\d]{4}-[a-z\d]{4}-[a-z\d]{12})/,
                host: /flowus\.cn/,
                name: 'FlowUsÊÅØÊµÅ',
                storage: 'hash'
            },
            'chrome': {
                reg: /^https?:\/\/chrome.google.com\/webstore\/.+?\/([a-z]{32})(?=[\/#?]|$)/,
                host: /chrome\.google\.com/,
                replaceHost: "chrome.crxsoso.com",
                name: 'ChromeÂïÜÂ∫ó',
            },
            'edge': {
                reg: /^https?:\/\/microsoftedge.microsoft.com\/addons\/.+?\/([a-z]{32})(?=[\/#?]|$)/,
                host: /microsoftedge\.microsoft\.com/,
                replaceHost: "microsoftedge.crxsoso.com",
                name: 'EdgeÂïÜÂ∫ó',
            },
            'firefox': {
                reg: /^https?:\/\/(reviewers\.)?(addons\.mozilla\.org|addons(?:-dev)?\.allizom\.org)\/.*?(?:addon|review)\/([^/<>"'?#]+)/,
                host: /addons\.mozilla\.org/,
                replaceHost: "addons.crxsoso.com",
                name: 'FirefoxÂïÜÂ∫ó',
            },
            'microsoft': {
                reg: /^https?:\/\/(?:apps|www).microsoft.com\/(?:store|p)\/.+?\/([a-zA-Z\d]{10,})(?=[\/#?]|$)/,
                host: /(apps|www)\.microsoft\.com/,
                replaceHost: "apps.crxsoso.com",
                name: 'WindowsÂïÜÂ∫ó',
            },
            'noire': {
                reg: /(?:https?:\/\/)?drive\.noire\.cc\/s\/\w+/,
                host: /drive\.noire\.cc/,
                input: ['#pwd'],
                button: ['button.MuiButton-containedSecondary'],
                name: 'Áà±‰∏Ω‰∏ùÁöÑËÆ∞‰∫ãÊú¨',
                storage: 'local',
                storagePwdName: 'tmp_noire_pwd',
                originalLink: true,
            },
        };
    }

    /**
     * ÂàùÂßãÂåñÈÖçÁΩÆÊï∞ÊçÆ
     */
    function initSettings() {
        CONSTANTS.DEFAULT_SETTINGS.forEach(setting => {
            if (util.getValue(setting.name) === undefined) {
                util.setValue(setting.name, setting.value);
            }
        });
    }

    /**
     * Ê∑ªÂä†È°µÈù¢‰∫ã‰ª∂ÁõëÂê¨
     */
    function addPageListeners() {
        document.addEventListener("mouseup", smartIdentify, true);
        document.addEventListener("keydown", handleKeyPress, true);
    }

    /**
     * Ëé∑ÂèñÈÄâ‰∏≠ÂÜÖÂÆπÁöÑHTMLÊàñÊñáÊú¨
     * @param {Selection} selection - ÈÄâÊã©ÂØπË±°
     * @param {boolean} isDOM - ÊòØÂê¶ËøîÂõûDOMÂØπË±°
     * @returns {string|HTMLElement} ÈÄâ‰∏≠ÁöÑÂÜÖÂÆπ
     */
    function getSelectionContent(selection, isDOM = false) {
        const testDiv = document.createElement("div");
        if (!selection.isCollapsed) {
            const docFragment = selection.getRangeAt(0).cloneContents();
            testDiv.appendChild(docFragment);
        }
        return isDOM ? testDiv : selection.toString();
    }

    /**
     * Êô∫ËÉΩËØÜÂà´ÈÄâ‰∏≠ÁöÑÊñáÊú¨
     * @param {Event} event - ‰∫ã‰ª∂ÂØπË±°
     * @param {string} str - Ë¶ÅËØÜÂà´ÁöÑÂ≠óÁ¨¶‰∏≤
     */
    async function smartIdentify(event, str = '') {
        const selection = window.getSelection();
        const text = str || getSelectionContent(selection);

        // Ëá™Âä®Êé®ÂØºÁΩëÁõòÂâçÁºÄÁöÑÂºÄÂÖ≥
        const isAutoComplete = util.getValue('setting_auto_complete');
        const isTextAsPassword = util.getValue('setting_text_as_password');

        // ÈÄâÊã©Áõ∏ÂêåÊñáÂ≠óÊàñÁ©∫‰∏çËØÜÂà´
        if (text !== lastText && text !== '') {
            const startTime = performance.now();
            lastText = text;
            util.clog(`ÂΩìÂâçÈÄâ‰∏≠ÊñáÂ≠óÔºö${text}`);

            // Ëß£ÊûêÈìæÊé•ÂíåÂØÜÁ†Å
            let linkObj = parseLink(text);
            util.clog(`Ëß£ÊûêÁªìÊûúÔºö${JSON.stringify(linkObj)}`);

            let { link, name } = linkObj;
            let pwd = parsePassword(text);

            // ‰ªéÁà∂ÂÖÉÁ¥†Ëß£ÊûêÈìæÊé•
            if (!link) {
                linkObj = parseParentLink(selection);
                link = linkObj.link;
                name = linkObj.name;
            }

            // Â∞ÜË∂ÖÈìæÊé•ÊñáÊú¨‰Ωú‰∏∫ÂØÜÁ†Å
            if (isTextAsPassword && !pwd) {
                pwd = parseLinkTextAsPassword(selection);
            }

            // Ëá™Âä®Ë°•ÂÖ®ÈìæÊé•
            if (isAutoComplete && !link) {
                linkObj = parseLink(text, true);
                link = linkObj.link;
                name = linkObj.name;
            }

            // Â¶ÇÊûúÊâæÂà∞ÈìæÊé•
            if (link) {
                // Ë°•ÂÖ®ÂçèËÆÆÂ§¥
                if (!/https?:\/\//.test(link)) {
                    link = 'https://' + link;
                }

                // ËÆ°ÁÆóËÄóÊó∂
                const endTime = performance.now();
                const timeCost = (endTime - startTime).toFixed(3);
                util.clog(`ÊñáÊú¨ËØÜÂà´ÁªìÊûúÔºö${name} ÈìæÊé•Ôºö${link} ÂØÜÁ†ÅÔºö${pwd} ËÄóÊó∂Ôºö${timeCost}ÊØ´Áßí`);

                // ÊòæÁ§∫ÊèêÁ§∫Âπ∂Â§ÑÁêÜÁî®Êà∑Êìç‰Ωú
                handleLinkDetection(linkObj, link, name, pwd);
            }
        }
    }

    /**
     * Â§ÑÁêÜÊ£ÄÊµãÂà∞ÁöÑÈìæÊé•
     * @param {Object} linkObj - ÈìæÊé•ÂØπË±°
     * @param {string} link - ÈìæÊé•Âú∞ÂùÄ
     * @param {string} name - ÁΩëÁõòÂêçÁß∞
     * @param {string} pwd - ÂØÜÁ†Å
     */
    function handleLinkDetection(linkObj, link, name, pwd) {
        // Êõ¥Êñ∞ÊàêÂäüËØÜÂà´Ê¨°Êï∞
        util.setValue(
            'setting_success_times',
            util.getValue('setting_success_times') + 1
        );

        // Ëé∑ÂèñÂÆûÈôÖÁöÑstorageÂÄºÔºàÂ¶ÇÊûúÊòØÂáΩÊï∞ÂàôÊâßË°åÔºâ
        const storageType = typeof linkObj.storage === 'function'
            ? linkObj.storage()
            : linkObj.storage;

        // ÈÖçÁΩÆÂºπÁ™óÈÄâÈ°π
        const options = {
            title: `ÂèëÁé∞<span style="color: #2778c4;margin: 0 5px;">${name}</span>ÈìæÊé•`,
            html: `<span style="font-size: 0.8em;">${!!pwd ? 'ÂØÜÁ†ÅÔºö' + pwd : 'ÊòØÂê¶ÊâìÂºÄÔºü'}</span>`,
            confirmButtonText: 'ÊâìÂºÄ',
            cancelButtonText: 'ÂÖ≥Èó≠'
        };

        // Ê∑ªÂä†ÂÄíËÆ°Êó∂ËÆæÁΩÆ
        if (util.getValue('setting_timer_open')) {
            options.timer = util.getValue('setting_timer');
        }

        // ÊòæÁ§∫ÂºπÁ™óÂπ∂Â§ÑÁêÜÁî®Êà∑ÈÄâÊã©
        dialog.confirm(options).then(res => {
            lastText = 'lorem&';
            window.getSelection().empty();

            // Áî®Êà∑Á°ÆËÆ§ÊàñÂÄíËÆ°Êó∂ÁªìÊùü
            if (res.isConfirmed || res.dismiss === 'timer') {
                // Êú¨Âú∞Â≠òÂÇ®ÂØÜÁ†Å
                if (storageType === "local") {
                    util.setValue(linkObj.storagePwdName, pwd);
                }

                // ÊâìÂºÄÈìæÊé•
                const active = util.getValue('setting_active_in_front');
                if (pwd && !linkObj.originalLink) {
                    const extraLink = link.includes('?')
                        ? `${link}&pwd=${pwd}#${pwd}`
                        : `${link}?pwd=${pwd}#${pwd}`;
                    GM_openInTab(extraLink, { active });
                } else {
                    GM_openInTab(link, { active });
                }
            }
        });
    }

    /**
     * Â§ÑÁêÜÊåâÈîÆ‰∫ã‰ª∂
     * @param {Event} event - ‰∫ã‰ª∂ÂØπË±°
     */
    function handleKeyPress(event) {
        // ÂõûËΩ¶ÈîÆÁ°ÆËÆ§
        if (event.key === 'Enter') {
            const confirmBtn = document.querySelector(`.${CONSTANTS.CUSTOM_CLASSES.confirmButton}`);
            confirmBtn && confirmBtn.click();
        }

        // ESCÈîÆÂèñÊ∂à
        if (event.key === 'Escape') {
            const cancelBtn = document.querySelector(`.${CONSTANTS.CUSTOM_CLASSES.cancelButton}`);
            cancelBtn && cancelBtn.click();
        }
    }

    /**
     * Ê∑ªÂä†Âø´Êç∑ÈîÆÊîØÊåÅ
     */
    function addHotKeySupport() {
        const hotkey = util.getValue('setting_hotkeys');
        hotkeys(hotkey, (event) => {
            event.preventDefault();
            showIdentifyBox();
        });
    }

    /**
     * Ëß£ÊûêÊñáÊú¨‰∏≠ÁöÑÁΩëÁõòÈìæÊé•
     * @param {string} text - ÊñáÊú¨ÂÜÖÂÆπ
     * @param {boolean} autoCompletePrefix - ÊòØÂê¶Ëá™Âä®Ë°•ÂÖ®ÈìæÊé•ÂâçÁºÄ
     * @returns {Object} Ëß£ÊûêÁªìÊûú
     */
    function parseLink(text = '', autoCompletePrefix = false) {
        const result = { name: '', link: '', storage: '', storagePwdName: '' };
        if (!text) return result;

        try {
            text = decodeURIComponent(text);
        } catch (e) {
            // Ëß£Á†ÅÂ§±Ë¥•Âàô‰ΩøÁî®ÂéüÂßãÊñáÊú¨
        }

        // ÊñáÊú¨È¢ÑÂ§ÑÁêÜ
        text = text
            .replace(/[ÁÇπÈªû]/g, '.')
            .replace(/[\u4e00-\u9fa5()ÔºàÔºâ,\u200BÔºå\uD83C-\uDBFF\uDC00-\uDFFF]/g, '')
            .replace(/lanzous/g, 'lanzouw'); // ‰øÆÊ≠£lanzousÊâì‰∏çÂºÄÁöÑÈóÆÈ¢ò

        // ÂåπÈÖçÁΩëÁõòÈìæÊé•
        for (const name in PAN_CONFIGS) {
            const config = PAN_CONFIGS[name];

            // Ëá™Âä®Ë°•ÂÖ®ÈìæÊé•ÂâçÁºÄ
            if (autoCompletePrefix && config.autoCompleteReg) {
                text = text.replace(config.autoCompleteReg, `${config.autoCompleteUrlPrefix}$&`);
            }

            // Ê£ÄÊü•ÊòØÂê¶ÂåπÈÖçÂΩìÂâçÁΩëÁõò
            if (config.reg.test(text)) {
                const matches = text.match(config.reg);
                result.name = config.name;
                result.link = matches[0];
                result.storage = config.storage;
                result.storagePwdName = config.storagePwdName || null;
                result.originalLink = config.originalLink || false;

                // ÊõøÊç¢‰∏ªÊú∫Âêç
                if (config.replaceHost) {
                    result.link = result.link.replace(config.host, config.replaceHost);
                }

                return result;
            }
        }

        return result;
    }

    /**
     * ‰ªéÁà∂ÂÖÉÁ¥†Ëß£ÊûêÈìæÊé•
     * @param {Selection} selection - ÈÄâÊã©ÂØπË±°
     * @returns {Object} Ëß£ÊûêÁªìÊûú
     */
    function parseParentLink(selection) {
        const dom = getSelectionContent(selection, true).querySelector('*[href]');
        return parseLink(dom ? dom.href : "");
    }

    /**
     * Â∞ÜÈìæÊé•ÊñáÊú¨‰Ωú‰∏∫ÂØÜÁ†ÅËß£Êûê
     * @param {Selection} selection - ÈÄâÊã©ÂØπË±°
     * @returns {string} ÂØÜÁ†Å
     */
    function parseLinkTextAsPassword(selection) {
        const dom = getSelectionContent(selection, true).querySelector('*[href]');
        // ‰ªÖÊîØÊåÅËã±ÊñáÂ§ßÂ∞èÂÜô„ÄÅÊï∞Â≠ó‰Ωú‰∏∫ÂØÜÁ†Å
        if (dom && /^[a-zA-Z0-9]+$/.test(dom.innerText)) {
            return dom.innerText;
        }
        return '';
    }

    /**
     * Ëß£ÊûêÊñáÊú¨‰∏≠ÁöÑÊèêÂèñÁ†Å
     * @param {string} text - ÊñáÊú¨ÂÜÖÂÆπ
     * @returns {string} ÊèêÂèñÁ†Å
     */
    function parsePassword(text) {
        // ÊñáÊú¨È¢ÑÂ§ÑÁêÜ
        text = text
            .replace(/\u200B/g, '')
            .replace('%3A', ":")
            .replace(/(?:Êú¨Â∏ñ)?ÈöêËóèÁöÑ?ÂÜÖÂÆπ[Ôºö:]?/, "");

        // ÂåπÈÖçÊèêÂèñÁ†Å
        const match = text.match(CONSTANTS.PASSWORD_REGEX);
        return match ? match[0] : '';
    }

    /**
     * Ê†πÊçÆÂüüÂêçÊ£ÄÊµãÁΩëÁõòÁ±ªÂûã
     * @returns {string} ÁΩëÁõòÁ±ªÂûã
     */
    function detectPanType() {
        const hostname = location.hostname;
        for (const name in PAN_CONFIGS) {
            const config = PAN_CONFIGS[name];
            if (config.host.test(hostname)) {
                return name;
            }
        }
        return '';
    }

    /**
     * Ëá™Âä®Â°´ÂÜôÂØÜÁ†Å
     */
    function autoFillPassword() {
        // ‰ªéURLËé∑ÂèñÂØÜÁ†Å
        const queryPwd = util.parseQuery('pwd|p');
        const hashPwd = location.hash.slice(1).replace(/\W/g, ""); // ËøáÊª§ÈùûÂØÜÁ†ÅÂ≠óÁ¨¶
        let pwd = queryPwd || hashPwd;

        // Ê£ÄÊµãÂΩìÂâçÁΩëÁõòÁ±ªÂûã
        const panType = detectPanType();

        // Â§ÑÁêÜÂØπÂ∫îÁΩëÁõòÁöÑÂØÜÁ†ÅÂ°´ÂÜô
        for (const name in PAN_CONFIGS) {
            const config = PAN_CONFIGS[name];
            if (panType === name) {
                // Ëé∑ÂèñÂÆûÈôÖÁöÑstorageÂÄºÔºàÂ¶ÇÊûúÊòØÂáΩÊï∞ÂàôÊâßË°åÔºâ
                const storageType = typeof config.storage === 'function'
                    ? config.storage()
                    : config.storage;

                // Êú¨Âú∞Â≠òÂÇ®ÁöÑÂØÜÁ†Å
                if (storageType === 'local') {
                    // URL‰∏≠ÂØÜÁ†Å‰ºòÂÖà
                    pwd = pwd || util.getValue(config.storagePwdName);
                    pwd && fillPasswordAndSubmit(config.input, config.button, pwd);
                }

                // Hash‰∏≠ÁöÑÂØÜÁ†Å
                if (storageType === 'hash') {
                    // ËøáÊª§‰∏çÊ≠£Â∏∏ÁöÑHash
                    if (/^(?:wss:[a-zA-Z\d]+|[a-zA-Z0-9]{3,8})$/.test(pwd)) {
                        pwd && fillPasswordAndSubmit(config.input, config.button, pwd);
                    }
                }
            }
        }
    }

    /**
     * Â°´ÂÜôÂØÜÁ†ÅÂπ∂Êèê‰∫§
     * @param {string[]} inputSelectors - ËæìÂÖ•Ê°ÜÈÄâÊã©Âô®
     * @param {string[]} buttonSelectors - ÊåâÈíÆÈÄâÊã©Âô®
     * @param {string} pwd - ÂØÜÁ†Å
     */
    /* function fillPasswordAndSubmit(inputSelectors, buttonSelectors, pwd) {
        let attempts = 10; // ÊúÄÂ§ßÂ∞ùËØïÊ¨°Êï∞
        const interval = setInterval(async () => {
            attempts--;
    
            // Êü•ÊâæËæìÂÖ•Ê°ÜÂíåÊåâÈíÆ
            const input = util.query(inputSelectors);
            const button = util.query(buttonSelectors);
    
            // ÊâæÂà∞ÂèØËßÅÁöÑËæìÂÖ•Ê°Ü
            if (input && !util.isHidden(input)) {
                clearInterval(interval);
    
                // ÊòæÁ§∫ÊèêÁ§∫ - ‰ΩøÁî®‰øÆÂ§çÂêéÁöÑtoastÊñπÊ≥ï
                dialog.toast({
                    title: 'AIÂ∑≤ËØÜÂà´Âà∞ÂØÜÁ†ÅÔºÅÊ≠£Ëá™Âä®Â∏ÆÊÇ®Â°´ÂÜô',
                    icon: 'success',
                    timer: 2000
                });
    
                // Â°´ÂÜôÂØÜÁ†Å
                const lastValue = input.value;
                input.value = pwd;
    
                // Ëß¶ÂèëËæìÂÖ•‰∫ã‰ª∂ÔºàÂÖºÂÆπVue/ReactÔºâ
                const event = new Event('input', { bubbles: true });
                const tracker = input._valueTracker;
                if (tracker) {
                    tracker.setValue(lastValue);
                }
                input.dispatchEvent(event);
    
                // Ëá™Âä®ÁÇπÂáªÊèê‰∫§ÊåâÈíÆ
                if (util.getValue('setting_auto_click_btn')) {
                    await util.sleep(1000); // Âª∂Ëøü1ÁßíÁÇπÂáª
                    button.click();
                }
            } else if (attempts <= 0) {
                // Ë∂ÖËøáÊúÄÂ§ßÂ∞ùËØïÊ¨°Êï∞
                clearInterval(interval);
            }
        }, 800); // ÊØè800msÂ∞ùËØï‰∏ÄÊ¨°
    } */

    /**
     * Â°´ÂÜôÂØÜÁ†ÅÂπ∂Êèê‰∫§ÔºàÊîπËøõÁâàÔºâ
     * @param {string[]} inputSelectors - ËæìÂÖ•Ê°ÜÈÄâÊã©Âô®
     * @param {string[]} buttonSelectors - ÊåâÈíÆÈÄâÊã©Âô®
     * @param {string} pwd - ÂØÜÁ†Å
     */
    function fillPasswordAndSubmit(inputSelectors, buttonSelectors, pwd) {
        let attempts = 10; // ÊúÄÂ§ßÂ∞ùËØïÊ¨°Êï∞
        let delay = 800;   // ÂàùÂßãÂª∂ËøüÊó∂Èó¥
        let attemptCount = 0; // ÂΩìÂâçÂ∞ùËØïÊ¨°Êï∞
        let passwordFilled = false; // ÂØÜÁ†ÅÊòØÂê¶Â∑≤Â°´ÂÜô

        const interval = setInterval(() => {
            attemptCount++;
            attempts--;

            // Êü•ÊâæËæìÂÖ•Ê°ÜÂíåÊåâÈíÆ
            const input = util.query(inputSelectors);
            const button = util.query(buttonSelectors);
            

            // Â°´ÂÜôÂØÜÁ†ÅÈÄªËæëÔºàÁã¨Á´ã‰∫éÊåâÈíÆÁä∂ÊÄÅÔºâ
            if (input && !passwordFilled && !util.isHidden(input)) {
                passwordFilled = true;

                // ÊòæÁ§∫ÊèêÁ§∫
                dialog.toast({
                    title: 'AIÂ∑≤ËØÜÂà´Âà∞ÂØÜÁ†ÅÔºÅÊ≠£Ëá™Âä®Â∏ÆÊÇ®Â°´ÂÜô',
                    icon: 'success',
                    timer: 2000
                });

                // Â°´ÂÜôÂØÜÁ†Å
                const lastValue = input.value;
                input.value = pwd;

                // Ëß¶ÂèëËæìÂÖ•‰∫ã‰ª∂ÔºàÂÖºÂÆπVue/ReactÔºâ
                const event = new Event('input', { bubbles: true });
                const tracker = input._valueTracker;
                if (tracker) {
                    tracker.setValue(lastValue);
                }
                input.dispatchEvent(event);
            }

            // ÁÇπÂáªÊåâÈíÆÈÄªËæë
            if (passwordFilled && button && !button.disabled) {
                clearInterval(interval);

                // Ëá™Âä®ÁÇπÂáªÊèê‰∫§ÊåâÈíÆ
                if (util.getValue('setting_auto_click_btn')) {
                    setTimeout(() => button.click(), 1000); // Âª∂Ëøü1ÁßíÁÇπÂáª
                }
            } else if (attempts <= 0) {
                // Ë∂ÖËøáÊúÄÂ§ßÂ∞ùËØïÊ¨°Êï∞
                clearInterval(interval);

                if (!passwordFilled) {
                    // dialog.toast({
                    //     title: `Â∞ùËØï${attemptCount}Ê¨°Âêé‰ªçÊú™ÊâæÂà∞ÂØÜÁ†ÅËæìÂÖ•Ê°Ü`,
                    //     icon: 'error',
                    //     timer: 3000
                    // });
                    //ÊúâÂèØËÉΩÊú™ÊâæÂà∞ÂØÜÁ†ÅËæìÂÖ•Ê°ÜÔºå‰πüÊúâÂèØËÉΩÊó†ÈúÄÂØÜÁ†ÅÔºåÊâÄ‰ª•‰∏çÊèêÁ§∫
                } else if (!button) {
                    dialog.toast({
                        title: `Â∞ùËØï${attemptCount}Ê¨°Âêé‰ªçÊú™ÊâæÂà∞Êèê‰∫§ÊåâÈíÆ`,
                        icon: 'error',
                        timer: 3000
                    });
                } else {
                    dialog.toast({
                        title: `Â∞ùËØï${attemptCount}Ê¨°ÂêéÊèê‰∫§ÊåâÈíÆ‰ªç‰∏çÂèØÁî®`,
                        icon: 'error',
                        timer: 3000
                    });
                }
            } else {
                // ÊåáÊï∞ÈÄÄÈÅøÔºöÊØèÊ¨°Â∞ùËØïÂêéÂ¢ûÂä†Âª∂ËøüÊó∂Èó¥
                delay = Math.min(delay * 1.5, 5000); // ÊúÄÂ§ßÂª∂Ëøü5Áßí

                // ËÆ°ÁÆó‰∏ãÊ¨°ÈáçËØïÁöÑÁßíÊï∞Ôºà‰øùÁïô‰∏Ä‰ΩçÂ∞èÊï∞Ôºâ
                const nextRetrySeconds = (delay / 1000).toFixed(1);

                // ÊòæÁ§∫ÈáçËØïÊèêÁ§∫
                let message = '';
                if (!passwordFilled) {
                    //message = `Â∞ùËØï${attemptCount}Ê¨°ÔºåÊú™ÊâæÂà∞ÂØÜÁ†ÅËæìÂÖ•Ê°ÜÔºå${nextRetrySeconds}ÁßíÂêéÈáçËØïÔºàÂâ©‰Ωô${attempts}Ê¨°Ôºâ`;
                    //ÊúâÂèØËÉΩÊú™ÊâæÂà∞ÂØÜÁ†ÅËæìÂÖ•Ê°ÜÔºå‰πüÊúâÂèØËÉΩÊó†ÈúÄÂØÜÁ†ÅÔºåÊâÄ‰ª•‰∏çÊèêÁ§∫
                } else if (!button) {
                    message = `ÂØÜÁ†ÅÂ∑≤Â°´ÂÜôÔºåÂ∞ùËØï${attemptCount}Ê¨°ÔºåÊú™ÊâæÂà∞Êèê‰∫§ÊåâÈíÆÔºå${nextRetrySeconds}ÁßíÂêéÈáçËØïÔºàÂâ©‰Ωô${attempts}Ê¨°Ôºâ`;
                } else {
                    message = `ÂØÜÁ†ÅÂ∑≤Â°´ÂÜôÔºåÂ∞ùËØï${attemptCount}Ê¨°ÔºåÊèê‰∫§ÊåâÈíÆ‰∏çÂèØÁî®Ôºå${nextRetrySeconds}ÁßíÂêéÈáçËØïÔºàÂâ©‰Ωô${attempts}Ê¨°Ôºâ`;
                }

                dialog.toast({
                    title: message,
                    icon: 'info',
                    timer: 1000
                });
            }
        }, delay);
    }
    /**
     * ÈáçÁΩÆËØÜÂà´Ê¨°Êï∞
     */
    function resetIdentifyCount() {
        dialog.confirm({
            title: 'Á°ÆÂÆöË¶ÅÈáçÁΩÆËØÜÂà´Ê¨°Êï∞ÂêóÔºü',
            text: '',
            confirmButtonText: 'Á°ÆÂÆö',
            cancelButtonText: 'ÂèñÊ∂à'
        }).then(res => {
            lastText = 'lorem&';
            if (res.isConfirmed) {
                util.setValue('setting_success_times', 0);
                history.go(0);
            }
        });
    }

    /**
     * ÊòæÁ§∫ËØÜÂà´Ê°Ü
     */
    function showIdentifyBox() {
        const hotkeys = util.getValue('setting_hotkeys');

        const html = `
        <textarea
            placeholder="Ëã•ÈÄâÊñπÂºè‰∏ÄÔºåËØ∑Êåâ Ctrl+V Á≤òË¥¥Ë¶ÅËØÜÂà´ÁöÑÊñáÂ≠ó"
            id="panai-textarea"
        ></textarea>
        <div style="font-size: 12px;color: #999;margin-bottom: 8px;text-align: center;">
            ÊèêÁ§∫ÔºöÂú®‰ªªÊÑèÁΩëÈ°µÊåâ‰∏ã <span style="font-weight: 700;">${hotkeys}</span> ÈîÆÂèØÂø´ÈÄüÊâìÂºÄÊú¨Á™óÂè£„ÄÇ
        </div>
        <div style="font-size: 14px;line-height: 22px;padding: 10px 0 5px;text-align: left;">
            <div style="font-size: 16px;margin-bottom: 8px;font-weight: 700;">ÊîØÊåÅ‰ª•‰∏ã‰∏§ÁßçÊñπÂºèÔºö</div>
            <div><b>ÊñπÂºè‰∏ÄÔºö</b>Áõ¥Êé•Á≤òË¥¥ÊñáÂ≠óÂà∞ËæìÂÖ•Ê°ÜÔºåÁÇπÂáª‚ÄúËØÜÂà´ÊñπÊ°ÜÂÜÖÂÆπ‚ÄùÊåâÈíÆ„ÄÇ</div>
            <div>
                <b>ÊñπÂºè‰∫åÔºö</b>ÁÇπÂáª‚ÄúËØªÂèñÂâ™ÂàáÊùø‚ÄùÊåâÈíÆ„ÄÇ
                <span style="color: #d14529;font-size: 12px;">
                    ‰ºöÂºπÂá∫‚ÄúÊéà‰∫àÁΩëÁ´ôËØªÂèñÂâ™ÂàáÊùø‚ÄùÊùÉÈôêÔºåÂêåÊÑèÂêé‰ºöËá™Âä®ËØÜÂà´Ââ™ÂàáÊùø‰∏≠ÁöÑÊñáÂ≠ó„ÄÇ
                </span>
            </div>
        </div>
    `;

        dialog.confirmWithDeny({
            title: 'ËØÜÂà´Ââ™ÂàáÊùø‰∏≠ÊñáÂ≠ó',
            html: html,
            confirmButtonText: 'ËØÜÂà´ÊñπÊ°ÜÂÜÖÂÆπ',
            denyButtonText: 'ËØªÂèñÂâ™ÂàáÊùø',
            cancelButtonText: 'ÂÖ≥Èó≠'
        }).then(res => {
            util.clog(res)
            if (res.isConfirmed) {
                const value = res.inputValues['panai-textarea']
                smartIdentify(null, value);
            }
            if (res.isDenied) {
                navigator.clipboard.readText()
                    .then(text => smartIdentify(null, text))
                    .catch(() => {
                        // ‰ΩøÁî®‰øÆÂ§çÂêéÁöÑtoastÊñπÊ≥ï
                        dialog.toast({
                            title: 'ËØªÂèñÂâ™ÂàáÊùøÂ§±Ë¥•ÔºåËØ∑ÂÖàÊéàÊùÉÊàñÊâãÂä®Á≤òË¥¥ÂêéËØÜÂà´ÔºÅ',
                            icon: 'error'
                        });
                    });
            }
        });
    }
    /**
     * ÊòæÁ§∫ËÆæÁΩÆÊ°Ü
     */
    function showSettingsBox() {
        // ÈÖçÁΩÆÊâÄÊúâËÆæÁΩÆÈ°πÔºàÊÅ¢Â§çÁº∫Â§±ÁöÑËÆæÁΩÆÈ°πÔºâ
        const settings = [
            {
                id: 'S-Auto',
                storageKey: 'setting_auto_click_btn',
                type: 'checkbox',
                label: 'Â°´ÂÜôÂØÜÁ†ÅÂêéËá™Âä®Êèê‰∫§',
                className: 'panai-setting-checkbox'
            },
            {
                id: 'S-Active',
                storageKey: 'setting_active_in_front',
                type: 'checkbox',
                label: 'ÂâçÂè∞ÊâìÂºÄÁΩëÁõòÊ†áÁ≠æÈ°µ',
                className: 'panai-setting-checkbox'
            },
            {
                id: 'S-Timer-Open',
                storageKey: 'setting_timer_open',
                type: 'checkbox',
                label: 'ÂÄíËÆ°Êó∂ÁªìÊùüËá™Âä®ÊâìÂºÄ',
                className: 'panai-setting-checkbox',
                onChange: (value, elements) => {
                    elements['Panai-Range-Wrapper'].style.display = value ? 'flex' : 'none';
                }
            },
            {
                id: 'Panai-Range-Wrapper',
                type: 'wrapper',
                label: `
                <span>ÂÄíËÆ°Êó∂ <span id="Timer-Value">Ôºà{{timer}}ÁßíÔºâ</span></span>
                <input type="range" id="S-Timer" data-storage-key="setting_timer" min="0" max="10000" step="500" value="{{timer}}" style="width: 200px;">
            `,
                dependsOn: 'S-Timer-Open'
            },
            {
                id: 'S-Text-As-Password',
                storageKey: 'setting_text_as_password',
                type: 'checkbox',
                label: 'Ë∂ÖÈìæÊé•ÁöÑÊñáÊú¨ÂÜÖÂÆπ‰Ωú‰∏∫ÂØÜÁ†ÅÔºàÂÆûÈ™åÊÄßÔºâ',
                className: 'panai-setting-checkbox'
            },
            {
                id: 'S-Auto-Complete',
                storageKey: 'setting_auto_complete',
                type: 'checkbox',
                label: 'Ëá™Âä®Êé®ÂØºÁΩëÁõòÈìæÊé•(ÂÆûÈ™åÊÄß)',
                className: 'panai-setting-checkbox',
                title: 'ÁõÆÂâç‰ªÖÊîØÊåÅÁôæÂ∫¶„ÄÅËøÖÈõ∑„ÄÅÂ§∏ÂÖãÁ≠âÁΩëÁõòÈìæÊé•ËøõË°åËá™Âä®Êé®ÂØºË°•ÂÖ®'
            },
            {
                id: 'S-hotkeys',
                storageKey: 'setting_hotkeys',
                type: 'text',
                label: 'Âø´Êç∑ÈîÆËÆæÁΩÆ',
                style: 'width: 100px;',
                defaultValue: 'F1'
            }
        ];

        // Ëé∑ÂèñÊâÄÊúâËÆæÁΩÆÂÄºÂπ∂ÁºìÂ≠ò
        const settingValues = {};
        settings.forEach(setting => {
            if (setting.storageKey) {
                // Á°Æ‰øùÂÄº‰∏ç‰∏∫undefined
                const storedValue = util.getValue(setting.storageKey);
                settingValues[setting.storageKey] = storedValue !== undefined
                    ? storedValue
                    : setting.defaultValue !== undefined
                        ? setting.defaultValue
                        : setting.type === 'checkbox' ? false : '';
            }
        });

        // ÁîüÊàêHTML
        let html = '<div style="font-size: 1em;">';
        settings.forEach(setting => {
            // Â§ÑÁêÜÊôÆÈÄöËæìÂÖ•È°π
            if (['checkbox', 'text', 'range'].includes(setting.type)) {
                const value = settingValues[setting.storageKey];
                const checked = setting.type === 'checkbox' && value ? 'checked' : '';
                const title = setting.title ? `title="${setting.title}"` : '';
                const style = setting.style ? `style="${setting.style}"` : '';
                const className = setting.className ? setting.className : '';
                const inputValue = setting.type === 'text' ? (value || '') : '';

                html += `
                <label class="panai-setting-label" ${title}>
                    ${setting.label}
                    <input type="${setting.type}" id="${setting.id}" data-storage-key="${setting.storageKey}"
                           ${checked} ${setting.type === 'text' ? `value="${inputValue}"` : ''}
                           class="${className}" ${style}>
                </label>
            `;
            }
            // Â§ÑÁêÜÂåÖË£ÖÂô®Á±ªÂûã
            else if (setting.type === 'wrapper') {
                const dependsSetting = settings.find(s => s.id === setting.dependsOn);
                const dependsValue = dependsSetting ? settingValues[dependsSetting.storageKey] : false;
                const display = dependsValue ? '' : 'display: none';
                // ÊõøÊç¢Ê®°ÊùøÂèòÈáè
                const timerValue = settingValues.setting_timer || 5000;
                const labelHtml = setting.label.replace(
                    /{{timer}}/g,
                    timerValue / 1000
                );

                html += `
                <label class="panai-setting-label" id="${setting.id}" style="${display}">
                    ${labelHtml}
                </label>
            `;
            }
        });
        html += '</div>';

        // ÊòæÁ§∫ÂØπËØùÊ°ÜÔºàÊó†‰øùÂ≠òÊåâÈíÆÔºåÂè™ÊúâÂÖ≥Èó≠ÊåâÈíÆÔºâ
        dialog.alert({
            title: 'ËØÜÂà´Âä©ÊâãÈÖçÁΩÆ',
            html: html,
        }).then(res => {
            // ÂÖ≥Èó≠ÂØπËØùÊ°ÜÊó∂‰∏çÈúÄË¶ÅÈ¢ùÂ§ñÊìç‰ΩúÔºåÂõ†‰∏∫Â∑≤ÁªèÂÆûÊó∂‰øùÂ≠ò
        });

        // ÁºìÂ≠òÊâÄÊúâÂÖÉÁ¥†ÂºïÁî®
        const elements = {};
        settings.forEach(setting => {
            if (setting.id) {
                elements[setting.id] = document.getElementById(setting.id);
            }
        });
        // Ê∑ªÂä†È¢ùÂ§ñÈúÄË¶ÅÁöÑÂÖÉÁ¥†
        elements['Timer-Value'] = document.getElementById('Timer-Value');
        elements['S-Timer'] = document.getElementById('S-Timer'); // ÊòæÂºèËé∑ÂèñÊªëÂùóÂÖÉÁ¥†

        // ÂÆûÊó∂‰øùÂ≠òËÆæÁΩÆÁöÑÂáΩÊï∞
        const saveSetting = (setting, element) => {
            if (!setting.storageKey || !element) return;

            let value;
            switch (setting.type) {
                case 'checkbox':
                    value = element.checked;
                    break;
                case 'range':
                    value = parseInt(element.value, 10);
                    // Êõ¥Êñ∞ÊòæÁ§∫
                    if (elements['Timer-Value']) {
                        elements['Timer-Value'].innerText = `Ôºà${value / 1000}ÁßíÔºâ`;
                    }
                    break;
                case 'text':
                    value = element.value.trim() || setting.defaultValue || '';
                    break;
                default:
                    value = element.value;
            }

            // ‰øùÂ≠òÂÄº
            util.setValue(setting.storageKey, value);

            // ÊòæÁ§∫‰øùÂ≠òÊèêÁ§∫
            dialog.toast({
                title: 'ËÆæÁΩÆÂ∑≤Êõ¥Êñ∞',
                icon: 'success',
                timer: 1000
            });
        };

        // ÁªëÂÆö‰∫ã‰ª∂ÔºàÂêåÊó∂Â§ÑÁêÜUIÊõ¥Êñ∞ÂíåÂÆûÊó∂‰øùÂ≠òÔºâ
        settings.forEach(setting => {
            const element = elements[setting.id];
            if (element) {
                // ÂÆö‰πâÈÄöÁî®ÁöÑÂèòÊõ¥Â§ÑÁêÜÂáΩÊï∞
                const handleChange = (e) => {
                    const value = setting.type === 'checkbox' ? e.target.checked : e.target.value;

                    // ÊâßË°åËÆæÁΩÆÈ°πËá™Ë∫´ÁöÑÂèòÊõ¥ÈÄªËæëÔºàÂ¶ÇÊòæÁ§∫/ÈöêËóèÁõ∏ÂÖ≥Êéß‰ª∂Ôºâ
                    if (setting.onChange) {
                        setting.onChange(value, elements);
                    }

                    // ÂÆûÊó∂‰øùÂ≠òËÆæÁΩÆ
                    saveSetting(setting, element);
                };

                // Ê†πÊçÆËæìÂÖ•Á±ªÂûãÁªëÂÆöÂêàÈÄÇÁöÑ‰∫ã‰ª∂
                if (setting.type === 'range') {
                    // ÊªëÂùóÂÆûÊó∂Êõ¥Êñ∞
                    element.addEventListener('input', handleChange);
                } else {
                    // ÂÖ∂‰ªñÊéß‰ª∂Âú®ÂÄºÂèòÊõ¥Êó∂Êõ¥Êñ∞
                    element.addEventListener('change', handleChange);

                    // ÊñáÊú¨Ê°ÜÂú®ËæìÂÖ•Êó∂Â∞±ÂÆûÊó∂‰øùÂ≠ò
                    if (setting.type === 'text') {
                        element.addEventListener('input', handleChange);
                    }
                }
            }
        });

        // ÂàùÂßãÂåñÔºöÁ°Æ‰øùÈ¶ñÊ¨°ÊâìÂºÄÊó∂Ê≠£Á°ÆÊòæÁ§∫‰æùËµñÈ°π
        const timerOpenElement = elements['S-Timer-Open'];
        const timerWrapper = elements['Panai-Range-Wrapper'];

        if (timerOpenElement && timerWrapper) {
            const isTimerEnabled = timerOpenElement.checked;
            timerWrapper.style.display = isTimerEnabled ? 'flex' : 'none';
        }
    }

    /**
     * Ê≥®ÂÜåËèúÂçïÂëΩ‰ª§
     */
    function registerMenuCommands() {
        GM_registerMenuCommand(
            `üëÄ Â∑≤ËØÜÂà´Ôºö${util.getValue('setting_success_times')}Ê¨°`,
            () => resetIdentifyCount()
        );

        GM_registerMenuCommand(
            `üìãÔ∏è ËØÜÂà´Ââ™ÂàáÊùø‰∏≠ÊñáÂ≠óÔºàÂø´Êç∑ÈîÆ ${util.getValue('setting_hotkeys')}Ôºâ`,
            () => showIdentifyBox()
        );

        GM_registerMenuCommand(
            '‚öôÔ∏è ËÆæÁΩÆ',
            () => showSettingsBox()
        );
    }

    /**
     * Ê∑ªÂä†Êèí‰ª∂Ê†∑Âºè
     */
    function addPluginStyles() {
        if (document.head) {
            util.addStyle(
                'panai-style',
                'style',
                CONSTANTS.PLUGIN_STYLES
            );
        }

        // ÁõëÂê¨headÂèòÂåñÔºåÁ°Æ‰øùÊ†∑ÂºèË¢´Ê∑ªÂä†
        const headObserver = new MutationObserver(() => {
            util.addStyle(
                'panai-style',
                'style',
                CONSTANTS.PLUGIN_STYLES
            );
        });

        headObserver.observe(document.head, { childList: true, subtree: true });
    }

    /**
     * Ê£ÄÊü•ÊòØÂê¶‰∏∫È°∂Â±ÇÁ™óÂè£
     * @returns {boolean} ÊòØÂê¶‰∏∫È°∂Â±ÇÁ™óÂè£
     */
    function isTopWindow() {
        return window.self === window.top;
    }

    /**
     * ÂàùÂßãÂåñÊèí‰ª∂
     */
    function initPanHelper() {
        // ÂàùÂßãÂåñËá™ÂÆö‰πâÂØπËØùÊ°Ü
        dialog = new Dialog();
        // ÂÖàÂàùÂßãÂåñÂ∑•ÂÖ∑
        util = createUtil();
        // ÂÜçÂàùÂßãÂåñÁΩëÁõòÈÖçÁΩÆÔºàÊ≠§Êó∂utilÂ∑≤ÂèØÁî®Ôºâ
        initPanConfigs();

        // ÊâßË°åÂàùÂßãÂåñÊµÅÁ®ã
        initSettings();
        addPluginStyles();
        addHotKeySupport();
        autoFillPassword();
        addPageListeners();

        // Âè™Âú®È°∂Â±ÇÁ™óÂè£Ê≥®ÂÜåËèúÂçïÂëΩ‰ª§
        if (isTopWindow()) {
            registerMenuCommands();
        }
    }

    // ÂêØÂä®Êèí‰ª∂
    initPanHelper();
})();